<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Consultancy | DashBoard Home</title>
    <link rel="stylesheet" href="../assets/css/dashHome.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="sidebar">
        <img src="../assets/images/logoNomeSemFundo.png" alt="">

        <div class="user-section">
            <img src="../assets/images/user.webp" alt="Usuário" class="user-icon">
            <p class="user-role">Analista</p>
        </div>

        <div class="menu">
            <button class="menu-btn" onclick="redirecionarHome()">Home</button>
            <button class="menu-btn" onclick="redirecionarAlerta()">Alertas</button>
        </div>

        <div class="logout-section">
            <button class="logout-btn" onclick="sair()">Sair</button>
        </div>
    </div>

    <div class="main-content">
        <div class="filters">
            <select id="statusSelect">
                <option value="1" selected>Critico</option>
                <option value="2">Alerta</option>
                <option value="3">Estavel</option>
            </select>

            <h3></h3>
        </div>

        <div class="dashboard">
            <div class="left-panel" id="dutosContainer">

            </div>
        </div>
    </div>
</body>

</html>

<script>

    function redirecionarHome() { window.location.href = 'dashHome.html' };
    function redirecionarAlerta() { window.location.href = 'dashAlerta.html' };
    function sair() { window.location.href = '../index.html' }

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/duto/dutos')
            .then(response => response.json())
            .then(data => {
                const dutosContainer = document.getElementById('dutosContainer');
                dutosContainer.innerHTML = ''; // Limpar a div

                // Criar um objeto para agrupar os dados por Duto
                const dutos = [];

                data.forEach(item => {
                    // Se o duto não existir no objeto dutos, cria um novo
                    if (!dutos[item.idDuto]) {
                        dutos[item.idDuto] = {
                            idDuto: item.idDuto,
                            diametro: item.diametro,
                            sensores: []
                        };
                    }

                    // Lógica de status com base na quantidade de alertas
                    let statusSensor = '';
                    if (item.qtdAlertasSemana > 5) {
                        statusSensor = 'Crítico';
                    } else if (item.qtdAlertasSemana == 5) {
                        statusSensor = 'Alerta';
                    } else {
                        statusSensor = 'Estável';
                    }

                    // Adiciona o sensor ao duto relacionado
                    dutos[item.idDuto].sensores.push({
                        idSensor: item.idSensor,
                        tipo: item.inicioDuto === 1 ? 'Início' : 'Fim',
                        status: statusSensor
                    });
                });

                console.log(dutos);

                const statusSelecionado = document.getElementById('statusSelect').value;

                // Mostrar cada duto
                dutos.forEach(duto => {
                    const sensores = duto.sensores.map(s => s.status);

                    let exibir = false;

                    if (statusSelecionado == '1') { // Crítico
                        exibir = sensores.includes('Crítico');
                    } else if (statusSelecionado == '2') { // Alerta
                        exibir = sensores.every(status => status === 'Alerta' || status === 'Estável') &&
                        sensores.includes('Alerta');
                    } else if (statusSelecionado == '3') { // Estável
                        exibir = sensores.every(status => status === 'Estável');
                    }

                    if (exibir) {
                        // Criar o container para o duto
                        const dutoContainer = document.createElement('div');
                        dutoContainer.classList.add('sensor-status-container');

                        // Criar o título do duto
                        const h3 = document.createElement('h3');
                        h3.textContent = `Duto ${duto.idDuto} - Altura: ${duto.diametro}cm`;
                        dutoContainer.appendChild(h3);

                        // Criar a lista de sensores
                        const ul = document.createElement('ul');
                        ul.classList.add('sensor-status-list');

                        // Iterar sobre os sensores do duto
                        duto.sensores.forEach(sensor => {
                            const li = document.createElement('li');
                            li.style.gap = '10px';

                            const spanSensorName = document.createElement('span');
                            spanSensorName.classList.add('sensor-name');
                            spanSensorName.textContent = `Sensor ${sensor.idSensor} - ${sensor.tipo}`;

                            const spanStatus = document.createElement('span');
                            spanStatus.classList.add('status');

                            if (sensor.status === 'Crítico') {
                                spanStatus.classList.add('critical');
                            } else if (sensor.status === 'Alerta') {
                                spanStatus.classList.add('alert');
                            } else {
                                spanStatus.classList.add('stable');
                            }

                            spanStatus.textContent = sensor.status;

                            li.appendChild(spanSensorName);
                            li.appendChild(spanStatus);
                            ul.appendChild(li);
                        });

                        dutoContainer.appendChild(ul);
                        dutosContainer.appendChild(dutoContainer);
                    }
                });
            })
            .catch(error => {
                console.error('Erro ao carregar os dados dos dutos:', error);
            });
    });

    document.getElementById('statusSelect').addEventListener('change', () => {
    document.dispatchEvent(new Event('DOMContentLoaded'));
    });

</script>